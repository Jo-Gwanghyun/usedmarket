<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>상품등록</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
    <th:block layout:fragment="script">
        <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
        <script>

            $(document).ready(function () {

                const dataTransfer = new DataTransfer();
                $("#addItemImage").change(function (){

                    let fileArr = document.getElementById("addItemImage").files;
                    let preview = document.querySelector("#preview");

                    if(dataTransfer.files.length >= 7){
                        alert("이미지는 최대 7개까지 등록가능합니다.")
                        document.getElementById("addItemImage").files = dataTransfer.files
                        return;
                    }

                    if(fileArr != null && fileArr.length > 0){
                            for (var i = 0; i < fileArr.length; i++) {
                                dataTransfer.items.add(fileArr[i]);
                                preview.innerHTML +=
                                    `<p id="${fileArr[i].lastModified}"> ${fileArr[i].name} <a data-index="${fileArr[i].lastModified}" class="bi bi-x-square" id="imageDelete"></a></p>`;
                                console.log("fileArr =>", fileArr[i].lastModified)
                            }
                        document.getElementById("addItemImage").files = dataTransfer.files;
                    }
                    console.log("dataTransfer = ",dataTransfer.files)
                    console.log("itemImages =",document.getElementById("addItemImage").files)
                });

                $("#preview").click(function(e){
                    if (e.target.className != "bi bi-x-square") return;
                    const targetFile = e.target.dataset.index;

                    for(var i=0;i<dataTransfer.files.length;i++){
                        if(targetFile == dataTransfer.files[i].lastModified){
                            dataTransfer.items.remove(i)
                            break
                        }
                    }
                    document.getElementById("addItemImage").files = dataTransfer.files;
                    const removeTarget = document.getElementById(targetFile);
                    removeTarget.remove();

                    console.log("dataTransfer = ",dataTransfer.files)
                    console.log("itemImages = ",document.getElementById("addItemImage").files)
                });
            });
        </script>
    </th:block>

    <div layout:fragment="content">

        <form id="form" role="form" method="post" enctype="multipart/form-data" th:object="${itemDto}">
            <p class="h2">
                상품등록
            </p>

            <input type="hidden" th:field="*{id}">

            <div class="input-group mb-3">
                <span class="input-group-text">상품명</span>
                <input type="text" th:field="*{itemName}" class="form-control" placeholder="상품명">
                <p th:if="${#fields.hasErrors('itemName')}" th:errors="*{itemName}" class="text-danger"></p>
            </div>


            <div class="input-group mb-3">
                <span class="input-group-text">가격</span>
                <input type="number" th:field="*{itemPrice}" class="form-control" placeholder="가격">
                <p th:if="${#fields.hasErrors('itemPrice')}" th:errors="*{itemPrice}" class="text-danger"></p>
            </div>

            <div class="input-group mb-3">
                <span class="input-group-text">상품설명</span>
                <textarea style="height: 300px" th:field="*{itemDetail}" class="form-control" placeholder="상품설명"></textarea>
                <p th:if="${#fields.hasErrors('itemDetail')}" th:errors="*{itemDetail}" class="text-danger"></p>
            </div>


            <!--상품이미지 리스트가 비어있는경우 이미지새로등록-->
            <div th:if="${#lists.isEmpty(itemDto.itemImageDtoList)}">
                    <p>대표이미지 등록</p>
                    <input type="file" class="form-control" id="addThumbnailImage" name="addThumbnailImage" accept="image/*">

                    <p>이미지 등록</p>
                    <input type="file" class="form-control" id="addItemImage" name="addItemImage" accept="image/*"
                           multiple="multiple" >
                    <ul id="preview"></ul>
            </div>


            <!--상품이미지 리스트가 비어있지않은경우 이미지수정-->
            <div th:if="${not #lists.isEmpty(itemDto.itemImageDtoList)}">
                <div class="input-group mb-3" th:each="itemImageDto, status : ${itemDto.itemImageDtoList}">
                    <label class="input-group-text" id="updateItemImageLabel" th:text="${not #strings.isEmpty(itemImageDto.originImageName)} ?
                    ${itemImageDto.originImageName} : '이미지' + ${status.index+1}"></label>
                    <input type="file" class="form-control" id="updateItemImage" name="updateItemImage">
                    <!--어떤이미지가 수정되었나 확인하기위해 히든타입 추가-->
                    <input type="hidden" id="itemImageId" name="itemImageId" th:value="${itemImageDto.id}">
                </div>
            </div>


            <div th:if="${#strings.isEmpty(itemDto.id)}" style="text-align: center">
                <button th:formaction="@{'/item/new'}" type="submit" class="btn btn-primary"
                id="addItemButton" name="addItemButton">등록</button>
                <button type="button" th:onclick="|location.href='@{/}'|" class="btn btn-secondary">취소</button>
            </div>


            <div th:unless="${#strings.isEmpty(itemDto.id)}" style="text-align: center">
                <button th:formaction="@{'/item/' + ${itemDto.id}}" type="submit" class="btn btn-primary">수정</button>
                <button type="button" class="btn btn-danger">삭제</button>
            </div>

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

        </form>
    </div>
</body>
</html>